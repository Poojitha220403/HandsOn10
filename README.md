# Hands-on L10: Spark Structured Streaming + Machine Learning with MLlib

## Overview
This hands-on assignment demonstrates a real-time ride-sharing analytics pipeline using **Apache Spark Structured Streaming** and **Spark MLlib**.  
It includes two major tasks:

- **Task 4 — Real-Time Fare Prediction**: A regression model that predicts fare amounts in real time based on ride distance.  
- **Task 5 — Time-Based Fare Trend Prediction**: A time-series regression model that predicts average fare trends over 5-minute time windows.

Both tasks use streaming ride events generated by a Python socket server.

---

## 🧩 Repository Structure
Handson-L10/
├── data_generator.py
├── task4.py
├── task5.py
├── training-dataset.csv
├── models/
│ ├── fare_model/
│ └── fare_trend_model_v2/
├── outputs_task4.txt
├── outputs_task5.txt
└── README.md

yaml
Copy code

---

## ⚙️ Setup Instructions

### 1️⃣ Install Dependencies
```bash
pip install pyspark faker
2️⃣ Start the Data Generator
Run this in Terminal 1:

bash
Copy code
python3 data_generator.py
You should see output similar to:

css
Copy code
Streaming data to localhost:9999...
Sent: {"trip_id":"...","driver_id":17,"distance_km":23.45,"fare_amount":67.20,"timestamp":"2025-10-21 17:30:00"}
The generator streams continuous JSON events to localhost:9999.

🚀 Task 4 – Real-Time Fare Prediction
🧠 Goal
Train a Linear Regression model to predict the fare amount from the distance (km) field and use it to score incoming streaming data.

🧱 Model Training
Loads training-dataset.csv

Converts columns to numeric types

Assembles features with VectorAssembler(inputCols=["distance_km"])

Trains a regression model (LinearRegression)

Saves the model in models/fare_model

🧮 Streaming Inference
Parses live JSON records from the socket

Assembles features

Uses the trained model to predict fares

Adds a deviation = |actual − predicted| column

Continuously writes results to the console

▶️ Run
Open Terminal 2 (keep generator running) and execute:

bash
Copy code
python3 task4.py | tee outputs_task4.txt
🧾 Sample Output
diff
Copy code
trip_id | driver_id | distance_km | fare_amount | predicted_fare | deviation
---------------------------------------------------------------------------
cf30c1b1-d090-42bd-82e5-6ff59a12bab5 | 72 | 39.93 | 134.18 | 88.33 | 45.85
ef861f11-0729-41fe-9bb3-400f890ae604 | 53 | 21.96 | 107.17 | 92.75 | 14.41
28758d09-c137-47a5-8a3a-cf948ccdb511 | 93 | 18.03 | 81.19  | 93.71 | 12.52
📸 See Screenshot 1 below.

📈 Task 5 – Time-Based Fare Trend Prediction
🧠 Goal
Predict average fare trends in real time using 5-minute window aggregations and time-based features (hour_of_day, minute_of_hour).

🧱 Model Training
Aggregates historical fares into 5-minute windows

Computes avg_fare per window

Adds time-based features (hour_of_day, minute_of_hour)

Trains a regression model to predict the next window’s average fare

Saves it under models/fare_trend_model_v2

🧮 Streaming Inference
Reads data from the same socket stream

Performs sliding 5-minute window aggregation (slides every 1 minute)

Applies the model for trend prediction

▶️ Run
Open Terminal 3:

bash
Copy code
python3 task5.py | tee outputs_task5.txt
🧾 Sample Output
yaml
Copy code
window_start          | window_end            | avg_fare | predicted_next_avg_fare
-------------------------------------------------------------------------------
2025-10-21 21:29:00   | 2025-10-21 21:34:00   | 76.05    | 92.39
2025-10-21 21:30:00   | 2025-10-21 21:35:00   | 79.12    | 90.81
📸 See Screenshot 2 below.

💡 Key Concepts Used
Concept	Description
Spark Structured Streaming	Handles continuous ingestion of live ride data via sockets.
VectorAssembler	Converts numeric columns into MLlib feature vectors.
LinearRegression (MLlib)	Learns regression models for fare and trend prediction.
Window Aggregations	Groups streaming data into fixed-size time windows for trend detection.
Pipeline Consistency	Ensures identical preprocessing in training and inference stages.

📸 Screenshots
Screenshot 1 – Task 4: Real-Time Fare Prediction

Screenshot 2 – Task 5: Time-Based Fare Trend Prediction

✅ Submission Checklist
 data_generator.py streams JSON ride data

 task4.py trains & predicts real-time fares

 task5.py trains & predicts fare trends

 Models created (fare_model, fare_trend_model_v2)

 Output logs (outputs_task4.txt, outputs_task5.txt)

 Screenshots attached

 README completed and documented

🏁 Results
Both Task 4 and Task 5 executed successfully:

Task 4: Produced continuous fare predictions with computed deviations.

Task 5: Captured average fare patterns dynamically across time windows.

✅ Demonstrates complete end-to-end streaming ML pipeline in Spark.